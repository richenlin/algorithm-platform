syntax = "proto3";

package api.v1;

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";

option go_package = "algorithm-platform/api/v1;v1";

service ManagementService {
  rpc CreateAlgorithm(CreateAlgorithmRequest) returns (Algorithm) {
    option (google.api.http) = {
      post: "/api/v1/algorithms"
      body: "*"
    };
  }

  rpc UpdateAlgorithm(UpdateAlgorithmRequest) returns (Algorithm) {
    option (google.api.http) = {
      put: "/api/v1/algorithms/{id}"
      body: "*"
    };
  }

  rpc ListAlgorithms(ListAlgorithmsRequest) returns (ListAlgorithmsResponse) {
    option (google.api.http) = {
      get: "/api/v1/algorithms"
    };
  }

  rpc CreateVersion(CreateVersionRequest) returns (Version) {
    option (google.api.http) = {
      post: "/api/v1/algorithms/{algorithm_id}/versions"
      body: "*"
    };
  }

  rpc RollbackVersion(RollbackVersionRequest) returns (Algorithm) {
    option (google.api.http) = {
      post: "/api/v1/algorithms/{algorithm_id}/versions/{version_id}/rollback"
    };
  }

  rpc UploadPresetData(UploadDataRequest) returns (UploadDataResponse) {
    option (google.api.http) = {
      post: "/api/v1/data/upload"
      body: "*"
    };
  }

  rpc ListPresetData(ListPresetDataRequest) returns (ListPresetDataResponse) {
    option (google.api.http) = {
      get: "/api/v1/data"
    };
  }

  rpc ListJobs(ListJobsRequest) returns (ListJobsResponse) {
    option (google.api.http) = {
      get: "/api/v1/jobs"
    };
  }

  rpc GetJobDetail(GetJobDetailRequest) returns (JobDetail) {
    option (google.api.http) = {
      get: "/api/v1/jobs/{job_id}/detail"
    };
  }
}

message CreateAlgorithmRequest {
  string name = 1;
  string description = 2;
  string language = 3;
  string platform = 4;
  string category = 5;
  string entrypoint = 6;
}

message UpdateAlgorithmRequest {
  string id = 1;
  string name = 2;
  string description = 3;
  string category = 4;
}

message Algorithm {
  string id = 1;
  string name = 2;
  string description = 3;
  string language = 4;
  string platform = 5;
  string category = 6;
  string entrypoint = 7;
  string current_version_id = 8;
  google.protobuf.Timestamp created_at = 9;
  google.protobuf.Timestamp updated_at = 10;
}

message ListAlgorithmsRequest {
  string category = 1;
  string language = 2;
  int32 page = 3;
  int32 page_size = 4;
}

message ListAlgorithmsResponse {
  repeated Algorithm algorithms = 1;
  int32 total = 2;
}

message CreateVersionRequest {
  string algorithm_id = 1;
  string source_code_zip_url = 2;
  string commit_message = 3;
}

message Version {
  string id = 1;
  string algorithm_id = 2;
  int32 version_number = 3;
  string minio_path = 4;
  string commit_message = 5;
  google.protobuf.Timestamp created_at = 6;
}

message RollbackVersionRequest {
  string algorithm_id = 1;
  string version_id = 2;
}

message UploadDataRequest {
  string filename = 1;
  string category = 2;
  string minio_path = 3;
}

message UploadDataResponse {
  string file_id = 1;
  string minio_url = 2;
}

message ListPresetDataRequest {
  string category = 1;
  int32 page = 2;
  int32 page_size = 3;
}

message ListPresetDataResponse {
  repeated PresetData files = 1;
  int32 total = 2;
}

message PresetData {
  string id = 1;
  string filename = 2;
  string category = 3;
  string minio_url = 4;
  google.protobuf.Timestamp created_at = 5;
}

message ListJobsRequest {
  string algorithm_id = 1;
  string status = 2;
  int32 page = 3;
  int32 page_size = 4;
}

message ListJobsResponse {
  repeated JobSummary jobs = 1;
  int32 total = 2;
}

message JobSummary {
  string job_id = 1;
  string algorithm_id = 2;
  string algorithm_name = 3;
  string status = 4;
  google.protobuf.Timestamp created_at = 5;
  int32 cost_time_ms = 6;
}

message GetJobDetailRequest {
  string job_id = 1;
}

message JobDetail {
  string job_id = 1;
  string algorithm_id = 2;
  string algorithm_name = 3;
  string mode = 4;
  string status = 5;
  string input_params = 6;
  string input_url = 7;
  string output_url = 8;
  string log_url = 9;
  google.protobuf.Timestamp created_at = 10;
  google.protobuf.Timestamp started_at = 11;
  google.protobuf.Timestamp finished_at = 12;
  int32 cost_time_ms = 13;
  string worker_id = 14;
}
